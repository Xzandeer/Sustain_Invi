{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Z:/code/app/api/forecast/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\n// Retry function to avoid Gemini model overload (503)\r\nasync function callWithRetry(fn: () => Promise<any>, retries = 3) {\r\n  for (let i = 0; i < retries; i++) {\r\n    try {\r\n      return await fn();\r\n    } catch (err: any) {\r\n      if (i === retries - 1) throw err;\r\n      await new Promise((res) => setTimeout(res, 500));\r\n    }\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const body = await req.json();\r\n    const { sales, categorySales } = body;\r\n\r\n    if (!process.env.GEMINI_API_KEY) {\r\n      return NextResponse.json(\r\n        { error: \"Gemini API key missing.\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\r\n\r\n    // âœ” Use a STABLE model!\r\nconst model = genAI.getGenerativeModel({\r\n  model: \"gemini-2.5-flash\",\r\n});\r\n\r\n\r\n    const prompt = `\r\nYou are an expert AI specializing in demand forecasting for retail surplus shops.\r\n\r\nDATA PROVIDED:\r\n- TOTAL DAILY SALES (chronological): \r\n${JSON.stringify(sales)}\r\n\r\n- CATEGORY SALES DATA (format: { category: [list of daily amounts] }):\r\n${JSON.stringify(categorySales)}\r\n\r\nYou are an expert AI specializing in retail demand forecasting.\r\n\r\nDATA:\r\n- TOTAL DAILY SALES: ${JSON.stringify(sales)}\r\n- CATEGORY SALES ({ category: [daily amounts] }): ${JSON.stringify(categorySales)}\r\n\r\nTASKS:\r\n1. Forecast the next 7 days of total sales.\r\n2. Forecast the next 7 days of sales for EACH category.\r\n3. Identify rising, falling, and unstable categories.\r\n4. Provide a 3-5 sentence analysis covering: restocking advice, next week's priority category, and low-demand risk areas.\r\n5. Make it organized and concise.\r\n\r\nReturn **VALID JSON ONLY** in this exact format:\r\n\r\n{\r\n  \"overallForecast\": [7 numbers],\r\n  \"categoryForecast\": {\r\n    \"CategoryName\": [7 numbers]\r\n  },\r\n  \"analysis\": \"string\"\r\n    `;\r\n\r\n    // GEMINI CALL WITH RETRY\r\n    const result = await callWithRetry(\r\n      () => model.generateContent(prompt),\r\n      3\r\n    );\r\n\r\n    let raw = result.response.text().trim();\r\n\r\n    // CLEAN JSON (remove ```json or ``` markers)\r\n    raw = raw.replace(/```json/g, \"\")\r\n             .replace(/```/g, \"\")\r\n             .replace(/[\\u0000-\\u001F]+/g, \"\") // remove invisible chars\r\n             .trim();\r\n\r\n    // Parse JSON SAFELY\r\n    let json;\r\n    try {\r\n      json = JSON.parse(raw);\r\n    } catch (err) {\r\n      console.error(\"Raw AI output was not valid JSON:\", raw);\r\n      throw new Error(\"Invalid AI JSON output\");\r\n    }\r\n\r\n    return NextResponse.json(json, { status: 200 });\r\n\r\n  } catch (e: any) {\r\n    console.error(\"Forecast API error:\", e);\r\n    return NextResponse.json(\r\n      { error: \"AI Forecasting failed\", details: e.message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,sDAAsD;AACtD,eAAe,cAAc,EAAsB,EAAE,UAAU,CAAC;IAC9D,IAAK,IAAI,IAAI,GAAG,IAAI,SAAS,IAAK;QAChC,IAAI;YACF,OAAO,MAAM;QACf,EAAE,OAAO,KAAU;YACjB,IAAI,MAAM,UAAU,GAAG,MAAM;YAC7B,MAAM,IAAI,QAAQ,CAAC,MAAQ,WAAW,KAAK;QAC7C;IACF;AACF;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,aAAa,EAAE,GAAG;QAEjC,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;YAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc;QAE/D,wBAAwB;QAC5B,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YACrC,OAAO;QACT;QAGI,MAAM,SAAS,CAAC;;;;;AAKpB,EAAE,KAAK,SAAS,CAAC,OAAO;;;AAGxB,EAAE,KAAK,SAAS,CAAC,eAAe;;;;;qBAKX,EAAE,KAAK,SAAS,CAAC,OAAO;kDACK,EAAE,KAAK,SAAS,CAAC,eAAe;;;;;;;;;;;;;;;;;IAiB9E,CAAC;QAED,yBAAyB;QACzB,MAAM,SAAS,MAAM,cACnB,IAAM,MAAM,eAAe,CAAC,SAC5B;QAGF,IAAI,MAAM,OAAO,QAAQ,CAAC,IAAI,GAAG,IAAI;QAErC,6CAA6C;QAC7C,MAAM,IAAI,OAAO,CAAC,YAAY,IACpB,OAAO,CAAC,QAAQ,IAChB,OAAO,CAAC,qBAAqB,IAAI,yBAAyB;SAC1D,IAAI;QAEd,oBAAoB;QACpB,IAAI;QACJ,IAAI;YACF,OAAO,KAAK,KAAK,CAAC;QACpB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,qCAAqC;YACnD,MAAM,IAAI,MAAM;QAClB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,MAAM;YAAE,QAAQ;QAAI;IAE/C,EAAE,OAAO,GAAQ;QACf,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAyB,SAAS,EAAE,OAAO;QAAC,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}